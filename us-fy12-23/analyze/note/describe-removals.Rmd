---
title: "FY12-23YTD ICE ERO descriptive analysis"
author: "UWCHR"
date: "2023-03-27"
output:
  pdf_document: default
  html_document: default
---
 

```{r setup, echo=FALSE, message=FALSE, include=TRUE}

library(pacman)

p_load(here, tidyverse, zoo, lubridate, ggplot2, plotly, gghighlight)

rem <- read_delim(here('us-fy12-23', 'analyze', 'input', 'removals.csv.gz'), delim='|',
                  col_types = cols(aor = col_character(),
                                   arrest_date = col_date(format="%m/%d/%Y"),
                                  departed_date = col_date(format="%m/%d/%Y"),
                                  case_close_date = col_date(format="%m/%d/%Y"),
                                  removal_date = col_date(format="%m/%d/%Y"),
                                  apprehension_method_code = col_character(),
                                  processing_disposition_code = col_factor(),
                                  citizenship_country = col_factor(),
                                  gender = col_factor(),
                                  final_charge_section = col_factor(),
                                  id = col_integer(),
                                  hashid = col_character()
                                  )) 

glimpse(rem)

redacted <- c('removal_threat_level', 'alien_file_number')

rem <- rem %>% 
  dplyr::select(-redacted)

rem <- rem %>% 
  mutate(year = year(departed_date),
         month = month(departed_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(departed_date),
         fy = substr(quarter(departed_date, fiscal_start=10, type="year.quarter"), 1,4),
         processing_disp = coalesce(processing_disposition_code, processing_disposition),
         date = coalesce(departed_date, removal_date))

rem_processing_disp_unique <- unique(tolower(rem$processing_disp))

write_lines(rem_processing_disp_unique, '../output/rem_processing_disp.txt')

```

```{r gender, echo=FALSE, message=FALSE, include=TRUE}

rem %>%
  mutate(gender = tolower(gender)) %>% 
  group_by(gender) %>% 
  summarize(n = n())

```


```{r cit, echo=FALSE, message=FALSE, include=TRUE}

rem %>%
  mutate(citizenship_country = tolower(citizenship_country)) %>% 
  group_by(citizenship_country) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))

```

Note "Not amenable to removal" largest category; check % of this and other categories like "foreign born usc", "not in custody" (also indicates no arrest?)

```{r disp, echo=FALSE, message=FALSE, include=TRUE}

top_10 <- rem %>%
  mutate(processing_disp = tolower(processing_disp)) %>% 
  group_by(processing_disp) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>%
  head(10)

print(top_10)

```


```{r expedited_removal, echo=FALSE, message=FALSE, include=TRUE}

er <- c('er', 'ex')

rem <- rem %>% 
  mutate(processing_disp = tolower(processing_disp),
         ex_rem = case_when(processing_disp %in% er ~ 'expedited removal',
                            str_detect(processing_disp, 'expedited removal') ~ 'expedited removal',
                            is.na(processing_disp) ~ 'all others',
                            TRUE ~ 'all others'))

p1 <- rem %>% 
  group_by(year, ex_rem) %>%
  ggplot(aes(x = year, fill=ex_rem)) +
  geom_bar(stat='count')

p1

p1 <- rem %>% 
  group_by(year, aor, ex_rem) %>%
  ggplot(aes(x = year, fill=ex_rem)) +
  geom_bar(stat='count') +
  facet_wrap(~aor, scales="free_y")

p1

```

```{r date_compare, echo=FALSE, message=FALSE, include=TRUE}

rem$dep_diff_rem <- difftime(rem$departed_date, rem$removal_date, units='days')

median(rem$dep_diff_rem, na.rm=TRUE)
mean(rem$dep_diff_rem, na.rm=TRUE)
max(rem$dep_diff_rem, na.rm=TRUE)
min(rem$dep_diff_rem, na.rm=TRUE)

h1 <- hist(as.numeric(rem$dep_diff_rem))

p1 <- plot(as.numeric(rem$dep_diff_rem))

```

```{r plot dates}

p1 <- plot(rem$id, rem$departed_date)

p2 <- plot(rem$id, rem$removal_date)

p3 <- plot(rem$removal_date, rem$departed_date)
```

