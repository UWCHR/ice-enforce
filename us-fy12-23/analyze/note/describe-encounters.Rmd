---
title: "FY12-23YTD ICE ERO encounters descriptive analysis"
author: "UWCHR"
date: "2023-03-27"
output:
    html_document:
        html_preview: true
        toc: true
        toc_depth: 3
        toc_float: true
        code_folding: hide
---
 

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

library(pacman)

p_load(here, tidyverse, zoo, lubridate, ggplot2, plotly, gghighlight)

enc <- read_delim(here('us-fy12-23', 'analyze', 'input', 'encounters.csv.gz'), delim='|',
                  col_types = cols(aor = col_factor(),
                                   event_date = col_character(),
                                   landmark = col_character(),
                                   operation = col_factor(),
                                   processing_disposition = col_factor(),
                                   citizenship_country = col_factor(),
                                   gender = col_factor(),
                                   hashid = col_character(),
                                   id = col_number()))

# glimpse(enc)

redacted <- c('encounter_threat_level', 'alien_file_number')

enc <- enc %>% 
  dplyr::select(-redacted)

enc <- enc %>% 
  mutate(event_date = as_date(event_date, format="%m/%d/%Y"),
         year = year(event_date),
         month = month(event_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(event_date),
         fy = substr(quarter(event_date, fiscal_start=10, type="year.quarter"), 1,4),
         gender = toupper(gender),
         operation = toupper(operation),
         processing_disposition = toupper(processing_disposition),
         citizenship_country = toupper(citizenship_country))

# skimr::skim(enc)

```

# Total encounters by FY

```{r fy_total, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30") %>% 
  group_by(fy) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n)) +
  geom_col() +
  labs(title = "Total ICE encounters per FY")

p1

```

# Basic demographics

Note increasing proportion of encounters involving females:

```{r gender, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# enc %>%
#   mutate(gender = toupper(gender)) %>% 
#   group_by(gender) %>% 
#   summarize(n = n())

p1 <- enc %>% 
  filter(event_date <= "2022-09-30") %>%
  count(fy, gender) %>% 
  ggplot(aes(x=fy, y=n, fill=gender)) +
  geom_col(position='fill') +
  scale_y_continuous(labels = scales::percent) +
  labs(title="Total ICE encounters, % by gender")

p1

```

Total ICE encounters by country of citizenship:

```{r cit, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

cit <- enc %>%
  filter(event_date <= "2022-09-30") %>% 
  mutate(citizenship_country = toupper(citizenship_country)) %>% 
  group_by(citizenship_country) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))

p1 <- enc %>% 
  filter(event_date <= "2022-09-30") %>%
  mutate(citizenship_country = case_when(
    citizenship_country %in% head(cit$citizenship_country, 15) ~ citizenship_country,
    TRUE ~ "ALL OTHERS"
  )) %>% 
  count(fy, citizenship_country) %>% 
  ggplot(aes(x=fy, y=n, fill=citizenship_country)) +
  geom_col() +
  labs(title = "Total ICE encounters by country of citizenship (top 15)")

ggplotly(p1)

```

Decreasing proportion of ICE encounters of U.S. citizens/and "unknown" nationality.

```{r cit_us_unk, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p2 <- enc %>% 
  filter(event_date <= "2022-09-30") %>%
  mutate(citizenship_country = case_when(
    citizenship_country %in% c("UNITED STATES", "UNKNOWN") ~ citizenship_country,
    TRUE ~ "ALL OTHERS"
  )) %>% 
  count(fy, citizenship_country) %>% 
  ggplot(aes(x=fy, y=n, fill=citizenship_country)) +
  geom_col(position="fill") +
  labs(title = "Total ICE encounters, proportion U.S./UNKNOWN")

p2

```

Below is an interactive chart of total ICE arrests per FY by AOR. Note significant quantity of encounters with missing ("NA") AOR, trend of missing values does not parallel overall trends.

```{r annual, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, color=aor, group=aor)) +
  geom_line() +
  labs(title = "Total ICE encounters per FY by AOR")

ggplotly(p1)

```

Below is a chart of total ICE encounters per FY, highlighting the Seattle AOR ("SEA"). Note relative stability of trend through presidential administrations, COVID pandemic:

```{r annual_specific, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

specific_aor = "SEA"

p2 <- enc %>% 
  filter(event_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, color=aor, group=aor)) +
  geom_line() +
  gghighlight(aor == specific_aor) +
  labs(title = "Total ICE encounters per FY",
       subtitle = paste0(specific_aor, " AOR highlighted"))

p2

# Encounter rank

```

# Percent change

Percent change in arrests per FY nationally and by AOR. Note comparison between groups may be misleading because smaller population AORs will be more volatile.

```{r arrests_pct_chg, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

natl_pct_chg <- enc %>%
  filter(event_date <= "2022-09-30") %>% 
  group_by(fy) %>%
  summarize(n = n()) %>% 
  mutate(pct_change = (n/lag(n) - 1))

p1 <- natl_pct_chg %>% 
  ggplot(aes(x = fy, y = pct_change)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  labs(title="FY % change in total ICE encounters")

p1

aor_pct_chg <- enc %>%
  filter(event_date <= "2022-09-30",
         !is.na(aor)) %>% 
  group_by(fy, aor) %>%
  summarize(n = n()) %>% 
  group_by(aor) %>% 
  arrange(fy, .by_group=TRUE) %>% 
  mutate(pct_change = (n/lag(n) - 1))

p2 <- aor_pct_chg %>% 
  ggplot(aes(x = fy, y = pct_change)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(breaks=seq(2012, 2022, 2)) +
  facet_wrap(~aor)  +
  labs(title="FY % change in total ICE encounters per AOR") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

p2

# Could try superimposing line chart of total arrests as above

```

# Operation

```{r enc_op}

ops <- enc %>% 
  count(operation) %>% 
  arrange(desc(n))

top_ops <- ops %>% 
  filter(n > 10000)

enc <- enc %>% 
  mutate(operation_short = case_when(operation %in% unlist(top_ops$operation) ~ as.character(operation), 
                                         TRUE ~ "ALL OTHERS"))

```

```{r enc_op_fy, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30",
         # !is.na(operation)
         ) %>% 
  group_by(fy, operation_short) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, fill=operation_short)) +
  geom_col() +
  labs(title = "Total ICE encounters per FY by operation")

ggplotly(p1)

```

```{r enc_op_sea, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30",
         aor == "SEA",
         # !is.na(operation)
         ) %>% 
  group_by(fy, aor, operation_short) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, fill=operation_short)) +
  geom_col() +
  labs(title = "Total ICE encounters per FY by operation (SEA AOR)")

ggplotly(p1)

```


# Processing disposition

```{r enc_disp, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

disps <- enc %>% 
  count(processing_disposition) %>% 
  arrange(desc(n))

top_disps <- disps %>% 
  filter(n > 10000)

enc <- enc %>% 
  mutate(disp_short = case_when(processing_disposition %in% unlist(top_disps$processing_disposition) ~ as.character(processing_disposition), 
                                         TRUE ~ "ALL OTHERS"))

```

```{r enc_disp_fy, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30",
         # !is.na(operation)
         ) %>% 
  group_by(fy, disp_short) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, fill=disp_short)) +
  geom_col() +
  labs(title = "Total ICE encounters per FY by processing disposition")

ggplotly(p1)

```

```{r enc_disp_fy_pct_not_amenable, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

not_amenable = c("NOT AMENABLE TO REMOVAL", "FOREIGN BORN USC")

fy_total <- enc %>% 
  group_by(fy) %>% 
  summarize(n_total = n())

fy_not_amenable <- enc %>% 
  filter(disp_short %in% not_amenable) %>% 
  group_by(fy) %>% 
  summarize(n_not_amenable = n())

dat <- left_join(fy_not_amenable, fy_total, by=c('fy')) %>% 
  mutate(pct_not_amenable = n_not_amenable/n_total)

p1 <- dat %>% 
  ggplot(aes(x = fy, y = pct_not_amenable)) +
  geom_col()

p1

fy_aor_total <- enc %>% 
  group_by(fy, aor) %>% 
  summarize(n_total = n())

fy_aor_not_amenable <- enc %>% 
  filter(disp_short %in% not_amenable) %>% 
  group_by(fy, aor) %>% 
  summarize(n_not_amenable = n())

dat <- left_join(fy_aor_not_amenable, fy_aor_total, by=c('fy', 'aor')) %>% 
  mutate(pct_not_amenable = n_not_amenable/n_total)

p2 <- dat %>% 
  ggplot(aes(x = fy, y = pct_not_amenable, fill = aor)) +
  geom_col() +
  facet_wrap(~aor)

p2
  
```

```{r enc_disp_sea, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30",
         aor == "SEA",
         # !is.na(operation)
         ) %>% 
  group_by(fy, aor, disp_short) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, fill=disp_short)) +
  geom_col()

ggplotly(p1)

```

# Landmark SEA

```{r enc_landmark, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

landmarks <- enc %>% 
  filter(event_date <= "2022-09-30",
         aor == "SEA") %>% 
  count(landmark) %>% 
  arrange(desc(n))

# top_landmarks <- landmarks %>% 
#   filter(n > 2500)

p1 <- enc %>% 
  filter(event_date <= "2022-09-30",
         aor == "SEA"
         ) %>% 
  mutate(landmark = case_when(landmark %in% head(landmarks$landmark, 15) ~ as.character(landmark), 
                                         TRUE ~ "ALL OTHERS")) %>% 
  group_by(fy, landmark) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, fill=landmark)) +
  geom_col() +
  labs(title = "Total ICE encounters per FY by landmark (top 15)")

ggplotly(p1)

p2 <- enc %>% 
  filter(event_date <= "2022-09-30",
         event_date >= "2021-10-01",
         aor == "SEA",
         !is.na(landmark)
         ) %>%
  group_by(year_mth, landmark) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = year_mth, y=n, fill=landmark)) +
  geom_col() +
  labs(title = "Total ICE encounters by landmark (all)")

ggplotly(p2)

```

```{r enc_landmark_not_amenable, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

p1 <- enc %>% 
  filter(event_date <= "2022-09-30",
         event_date >= "2021-10-01",
         aor == "SEA",
         processing_disposition %in% not_amenable,
         !is.na(landmark)
         ) %>%
  group_by(year_mth, landmark) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = year_mth, y=n, fill=landmark)) +
  geom_col() +
  labs(title = "Total ICE encounters per FY by landmark, not amenable to removal")

ggplotly(p1)

```

```{r tab_sea_enc_landmark, include=FALSE, message=FALSE, warning=FALSE}

tab_sea_enc_landmark <- enc %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         event_date > '2021-09-30') %>%
  count(year_mth, landmark) %>% 
    arrange(year_mth, landmark)

write_delim(tab_sea_enc_landmark, here('us-fy12-23', 'analyze', 'output', 'tab_sea_enc_landmark.csv'), delim=',')

```
