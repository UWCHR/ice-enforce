---
title: "FY12-23YTD ICE ERO descriptive analysis"
author: "UWCHR"
date: "2023-06-26"
output:
  pdf_document: default
  html_document: default
---
 

```{r setup, echo=FALSE, message=FALSE, include=TRUE}

library(pacman)

p_load(here, tidyverse, zoo, lubridate, ggplot2, plotly, gghighlight, yaml)

pd_dict <- read_delim(here('share', 'hand', 'processing_disp.csv'), delim='|')

enc <- read_delim(here('us-fy12-23', 'analyze', 'input', 'encounters.csv.gz'), delim='|',
                  col_types = cols(aor = col_character(),
                                   event_date = col_character(),
                                   landmark = col_character(),
                                   operation = col_factor(),
                                   processing_disposition = col_character(),
                                   citizenship_country = col_factor(),
                                   gender = col_factor(),
                                   hashid = col_character(),
                                   id = col_number())) 

# glimpse(enc)

redacted <- c('encounter_threat_level', 'alien_file_number')

enc <- enc %>% 
  dplyr::select(-redacted)

enc <- enc %>% 
  mutate(event_date = as_date(event_date, format="%m/%d/%Y"),
         year = year(event_date),
         month = month(event_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(event_date))

arr <- read_delim(here('us-fy12-23', 'analyze', 'input', 'arrests.csv.gz'), delim='|',
                  col_types = cols(aor = col_character(),
                                  arrest_date = col_date(format="%m/%d/%Y"),
                                  departed_date = col_date(format="%m/%d/%Y"),
                                  apprehension_landmark = col_character(),
                                  operation = col_factor(),
                                  processing_disposition = col_factor(),
                                  citizenship_country = col_factor(),
                                  gender = col_factor(),
                                  case_closed_date = col_date(format="%m/%d/%Y"),
                                  id = col_integer(),
                                  hashid = col_character()
                                  ))

glimpse(arr)

redacted <- c('removal_threat_level', 'apprehension_threat_level', 'alien_file_number')

arr <- arr %>%
  dplyr::select(-redacted)

arr <- arr %>%
  mutate(arrest_date = as_date(arrest_date, format="%m/%d/%Y"),
         year = year(arrest_date),
         month = month(arrest_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(arrest_date),
         fy = substr(quarter(arrest_date, fiscal_start=10, type="year.quarter"), 1,4))

rem <- read_delim(here('us-fy12-23', 'analyze', 'input', 'removals.csv.gz'), delim='|',
                  col_types = cols(aor = col_character(),
                                   arrest_date = col_date(format="%m/%d/%Y"),
                                  departed_date = col_date(format="%m/%d/%Y"),
                                  case_close_date = col_date(format="%m/%d/%Y"),
                                  removal_date = col_date(format="%m/%d/%Y"),
                                  apprehension_method_code = col_character(),
                                  processing_disposition_code = col_factor(),
                                  citizenship_country = col_factor(),
                                  gender = col_factor(),
                                  final_charge_section = col_factor(),
                                  id = col_integer(),
                                  hashid = col_character()
                                  ))

# glimpse(rem)

redacted <- c('removal_threat_level', 'alien_file_number')

rem <- rem %>%
  dplyr::select(-redacted)

rem <- rem %>%
  mutate(year = year(departed_date),
         month = month(departed_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(departed_date),
         fy = substr(quarter(departed_date, fiscal_start=10, type="year.quarter"), 1,4),
         processing_disposition = coalesce(processing_disposition_code, processing_disposition), # No correspondence of these two values
         date = coalesce(departed_date, removal_date))

```

```{r get_unique_pd_vals}

# enc_pd <- unique(str_to_upper(enc$processing_disposition))
# arr_pd <- unique(str_to_upper(arr$processing_disposition))
# rem_pd <- unique(str_to_upper(rem$processing_disp))
# 
# rem_n_pd <- rem %>% 
#   group_by(processing_disposition) %>% 
#   summarize(n=n()) %>% 
#   arrange(desc(n))
# 
# rem_n_pdc <- rem %>% 
#   group_by(processing_disposition_code) %>% 
#   summarize(n=n()) %>% 
#   arrange(desc(n))
# 
# pd <- unique(c(enc_pd, arr_pd, rem_pd))
# 
# write_lines(pd, here('us-fy12-23', 'analyze', 'output', 'processing_disp.txt'))

```

```{r standardize_pd_vals}

arr <- arr %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition))

arr <- left_join(arr, pd_dict, by=c('processing_disposition' = 'raw_processing_disposition'))

enc <- enc %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition))

enc <- left_join(enc, pd_dict, by=c('processing_disposition' = 'raw_processing_disposition'))

rem <- rem %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition))

rem <- left_join(rem, pd_dict, by=c('processing_disposition' = 'raw_processing_disposition'))

```

1. "Morton memo" era: 2011-11/2014
2.  "Felons not families" era: 11/2014-1/2017
3. Trump era: 1/2017-9/30/2021
4. Mayorkas era: 11/29/2021-6/10/2022 (note these dates are the dates it was actually in effect, I know they differ slightly from date of its publication; and on removals only, the Doyle memo dated 4/3/22 may also be a relevant benchmark date but would only apply to removals)
5. post-Mayorkas: 6/10/22 to end of dataset

```{r policy_periods, echo=FALSE, message=FALSE, include=TRUE}

morton_start <- '2011-01-01'
morton_end <- '2014-10-30'
ff_start <- '2014-11-01'
ff_end <- '2017-01-19'
trump_start <- '2017-01-20'
trump_end <- '2021-01-19'
mayorkas_start <- '2021-11-29'
mayorkas_end <- '2022-06-10'
post_mayorkas_start <- '2022-06-11'
post_mayorkas_end <- '2023-12-31'

policy_periods <- data.frame(xmin = c(morton_start,
                                      ff_start,
                                      trump_start,
                                      mayorkas_start,
                                      post_mayorkas_start),
                             xmax = c(morton_end,
                                      ff_end,
                                      trump_end,
                                      mayorkas_end,
                                      post_mayorkas_end),
                             labs = c("Morton",
                                      "Felons not Families",
                                      "Trump",
                                      "Mayorkas",
                                      "Post-Mayorkas"))

# rem <- rem %>% 
#   mutate(morton = between(date, as.Date(morton_start), as.Date(morton_end)),
#          felons_families = between(date, as.Date(ff_start), as.Date(ff_end)),
#          trump = between(date, as.Date(trump_start), as.Date(trump_end)),
#          mayorkas = between(date, as.Date(mayorkas_start), as.Date(mayorkas_end)),
#          post_mayorkas = between(date, as.Date(post_mayorkas_start), as.Date(post_mayorkas_end))
#          )

enc <- enc %>% 
  mutate(morton = between(event_date, as.Date(morton_start), as.Date(morton_end)),
         felons_families = between(event_date, as.Date(ff_start), as.Date(ff_end)),
         trump = between(event_date, as.Date(trump_start), as.Date(trump_end)),
         mayorkas = between(event_date, as.Date(mayorkas_start), as.Date(mayorkas_end)),
         post_mayorkas = between(event_date, as.Date(post_mayorkas_start), as.Date(post_mayorkas_end))
         )

# arr <- arr %>% 
#   mutate(morton = between(arrest_date, as.Date(morton_start), as.Date(morton_end)),
#          felons_families = between(arrest_date, as.Date(ff_start), as.Date(ff_end)),
#          trump = between(arrest_date, as.Date(trump_start), as.Date(trump_end)),
#          mayorkas = between(arrest_date, as.Date(mayorkas_start), as.Date(mayorkas_end)),
#          post_mayorkas = between(arrest_date, as.Date(post_mayorkas_start), as.Date(post_mayorkas_end))
#          )

```

Of Encounters data: using "processing disposition" and date, do we see any noticeable differences before/after the above benchmark dates?

```{r encounters_monthly, echo=FALSE, message=FALSE, include=TRUE}

enc_proc_top <- enc %>% 
  filter(!is.na(processing_disposition)) %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition)) %>% 
  group_by(processing_disposition) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n)) %>% 
  head(12)

enc_month <- enc %>% 
  filter(!is.na(processing_disposition)) %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition)) %>% 
  mutate(processing_disposition = case_when(processing_disposition %in% enc_proc_top$processing_disposition ~ processing_disposition,
         TRUE ~ 'OTHER')) %>% 
  group_by(year_mth, processing_disposition) %>% 
  summarize(total_encounters = n())

p1 <- enc_month %>% 
  ggplot(aes(x=year_mth, y=total_encounters, color=processing_disposition)) +
  geom_line() +
  geom_rect(aes(xmin = zoo::as.yearmon(xmin), xmax=zoo::as.yearmon(xmax), ymin=-Inf, ymax=Inf, fill=labs),
            data=policy_periods, alpha=.2, inherit.aes = FALSE) +
  scale_fill_viridis_d() +
  facet_wrap(~processing_disposition,  labeller = label_wrap_gen(16)) +
  guides(color=FALSE) + 
  theme(strip.text = element_text(size=8) )

p1

```

```{r corr_test}

enc_month_corr <- enc_month %>% 
  mutate(trump = between(year_mth, zoo::as.yearmon('2017-01-20'), zoo::as.yearmon('2021-09-30')))

p1 <- enc_month_corr %>% 
  ggplot(aes(x = trump, y=total_encounters, color=processing_disposition)) +
  geom_boxplot()

p1

enc_month_avg <- enc_month_corr %>% 
  group_by(trump, processing_disposition) %>% 
  summarize(avg_monthly_enc = mean(total_encounters))

test <- enc_month_corr %>% 
  filter(processing_disposition == "DETAINER")

cor(as.numeric(test$trump), test$total_encounters)
```

Correlation matrix: policy periods as categorical variable, create matrix of policy-periods/average monthly events per processing disposition category. What to do with time periods not in any policy period?


```{r aor}

aor_list <- sort(unique(enc$aor))

enc_month <- enc %>% 
  filter(!is.na(processing_disposition)) %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition)) %>% 
  mutate(processing_disposition = case_when(processing_disposition %in% enc_proc_top$processing_disposition ~ processing_disposition,
         TRUE ~ 'OTHER')) %>% 
  group_by(year_mth, processing_disposition) %>% 
  summarize(total_encounters = n())

enc_month_aor <- enc %>% 
  filter(!is.na(processing_disposition)) %>% 
  mutate(processing_disposition = str_to_upper(processing_disposition)) %>% 
  mutate(processing_disposition = case_when(processing_disposition %in% enc_proc_top$processing_disposition ~ processing_disposition,
         TRUE ~ 'OTHER')) %>% 
  group_by(year_mth, aor, processing_disposition) %>% 
  summarize(total_encounters = n())


pdf(here('us-fy12-23', 'analyze', 'output', 'aor-encounters-disposition.pdf'),width=6,height=3.25)

p1 <- enc_month %>% 
  ggplot(aes(x=year_mth, y=total_encounters, color=processing_disposition)) +
  geom_line() +
  geom_rect(aes(xmin = zoo::as.yearmon(xmin), xmax=zoo::as.yearmon(xmax), ymin=-Inf, ymax=Inf, fill=labs),
            data=policy_periods, alpha=.2, inherit.aes = FALSE) +
  scale_fill_viridis_d() +
  facet_wrap(~processing_disposition,  labeller = label_wrap_gen(16)) +
  guides(color=FALSE) + 
  theme(strip.text = element_text(size=6) ) +
  labs(title = "National")

plot(p1)

for (i in 1:length(aor_list)) {
  current_aor <- as.character(aor_list[i])
  
  p1 <- enc_month_aor %>% 
    filter(aor == current_aor) %>% 
    ggplot(aes(x=year_mth, y=total_encounters, color=processing_disposition)) +
    geom_line() +
    geom_rect(aes(xmin = zoo::as.yearmon(xmin), xmax=zoo::as.yearmon(xmax), ymin=-Inf, ymax=Inf, fill=labs),
              data=policy_periods, alpha=.2, inherit.aes = FALSE) +
    scale_fill_viridis_d() +
    facet_wrap(~processing_disposition,  labeller = label_wrap_gen(16)) +
    guides(color=FALSE) + 
    theme(strip.text = element_text(size=6) ) +
  labs(title = current_aor)
  
  p1
  
  plot(p1)
  # ggplotly(p1)
  
}
dev.off()

```
