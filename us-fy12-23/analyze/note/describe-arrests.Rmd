---
title: "FY12-23YTD ICE ERO descriptive analysis"
author: "UWCHR"
date: "2023-03-27"
output:
  html_document: default
  pdf_document: default
---
 

```{r setup, echo=FALSE, message=FALSE, include=TRUE}

library(pacman)

p_load(here, tidyverse, zoo, lubridate, ggplot2, plotly, gghighlight)

arr <- read_delim(here('us-fy12-23', 'analyze', 'input', 'arrests.csv.gz'), delim='|',
                  col_types = cols(aor = col_character(),
                                  arrest_date = col_date(format="%m/%d/%Y"),
                                  departed_date = col_date(format="%m/%d/%Y"),
                                  apprehension_landmark = col_character(),
                                  operation = col_factor(),
                                  processing_disposition = col_factor(),
                                  citizenship_country = col_factor(),
                                  gender = col_factor(),
                                  case_closed_date = col_date(format="%m/%d/%Y"),
                                  id = col_integer(),
                                  hashid = col_character()
                                  )) 

glimpse(arr)

redacted <- c('removal_threat_level', 'apprehension_threat_level', 'alien_file_number')

arr <- arr %>% 
  dplyr::select(-all_of(redacted))

arr <- arr %>% 
  mutate(arrest_date = as_date(arrest_date, format="%m/%d/%Y"),
         year = year(arrest_date),
         month = month(arrest_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(arrest_date),
         fy = substr(quarter(arrest_date, fiscal_start=10, type="year.quarter"), 1,4))

# arr_methods_unique <- unique(tolower(arr$arrest_method))
# arr_disp_unique <- unique(tolower(arr$processing_disposition))
# 
# 
# write_lines(arr_methods_unique, '../output/arr_methods.txt')
# write_lines(arr_disp_unique, '../output/arr_disp.txt')

```
 
 ## Basic demographics
 
```{r gender, echo=FALSE, message=FALSE, include=TRUE}

arr %>%
  mutate(gender = tolower(gender)) %>% 
  group_by(gender) %>% 
  summarize(n = n())

```

```{r cit, echo=FALSE, message=FALSE, include=TRUE}

arr %>%
  mutate(citizenship_country = tolower(citizenship_country)) %>% 
  group_by(citizenship_country) %>% 
  summarize(n = n()) %>% 
  arrange(desc(n))

```

## Total arrests

```{r fy_total, echo=FALSE, message=FALSE, include=TRUE}

p1 <- arr %>% 
  filter(arrest_date <= "2022-09-30") %>% 
  group_by(fy) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n)) +
  geom_col() +
  labs(title = "Total ICE arrests per FY")

p1

```

Below is an interactive chart of total ICE arrests per FY by AOR:

```{r annual, echo=FALSE, message=FALSE, include=TRUE}

p1 <- arr %>% 
  filter(arrest_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, color=aor, group=aor)) +
  geom_line() +
  labs(title = "Total ICE arrests per FY by AOR")

ggplotly(p1)

```

Below is a chart of total ICE arrests per FY, highlighting the Seattle AOR ("SEA"):

```{r annual_sea}


p2 <- arr %>% 
  filter(arrest_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n = n()) %>% 
  ggplot(aes(x = as.factor(fy), y=n, color=aor, group=aor)) +
  geom_line() +
  gghighlight(aor == "SEA") +
  labs(title = "Total ICE arrests per FY",
       subtitle = "Seattle AOR highlighted")

p2

```

Percent change in arrests per FY nationally and by AOR. Note comparison between groups may be misleading because smaller population AORs will be more volatile.

```{r arrests_pct_chg}

natl_pct_chg <- arr %>%
  filter(arrest_date <= "2022-09-30") %>% 
  group_by(fy) %>%
  summarize(n = n()) %>% 
  mutate(pct_change = (n/lag(n) - 1))

p1 <- natl_pct_chg %>% 
  ggplot(aes(x = fy, y = pct_change)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  labs(title="FY % change in total ICE arrests")

p1

aor_pct_chg <- arr %>%
  filter(arrest_date <= "2022-09-30",
         !is.na(aor)) %>% 
  group_by(fy, aor) %>%
  summarize(n = n()) %>% 
  group_by(aor) %>% 
  arrange(fy, .by_group=TRUE) %>% 
  mutate(pct_change = (n/lag(n) - 1))

p2 <- aor_pct_chg %>% 
  ggplot(aes(x = fy, y = pct_change)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(breaks=seq(2012, 2022, 2)) +
  facet_wrap(~aor)  +
  labs(title="FY % change in total ICE arrests per AOR") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

p2

# Could try superimposing line chart of total arrests as above

```

## Arrests by `arrest_method`

```{r method_setup, echo=FALSE, message=FALSE, include=TRUE}

methods <- arr %>% 
  count(arrest_method) %>% 
  arrange(desc(n))

top_methods <- methods %>% 
  filter(n > 10000)

arr <- arr %>% 
  mutate(arrest_method_short = case_when(arrest_method %in% unlist(top_methods$arrest_method) ~ as.character(arrest_method), 
                                         TRUE ~ "All others"))

```

Arrests trend down nationwide; slight bump up during Trump admin; big bump of NCA in 2022 (as ICE processed people initially encountered at souther border by BP?). Global decline CLC; NCA now >50% of arrests--but are these at-large community arrests or self-report? Look at trends in `processing_disposition`, `operation`, `apprehension_landmark`.

```{r national_arrest_method}

p1 <- arr %>% 
  group_by(fy, arrest_method_short) %>%
  ggplot(aes(x = fy, fill=arrest_method_short)) +
  geom_bar(stat='count', position='stack')

ggplotly(p1)

```

```{r arr_method_pct_chg}

method_pct_chg <- arr %>%
  filter(arrest_date <= "2022-09-30",
         !is.na(aor)) %>% 
  group_by(fy, arrest_method_short) %>%
  summarize(n = n()) %>% 
  group_by(arrest_method_short) %>% 
  arrange(fy, .by_group=TRUE) %>% 
  mutate(pct_change = (n/lag(n) - 1))

p1 <- method_pct_chg %>% 
  ggplot(aes(x = fy, y = pct_change)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent) +
  scale_x_discrete(breaks=seq(2012, 2022, 2)) +
  facet_wrap(~arrest_method_short, scales='free_y')  +
  labs(title="FY % change in total ICE arrests by arrest method") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

p1

```

```{r method_per_aor}

p2 <- arr %>% 
  filter(!is.na(aor),
         aor != "HQ") %>% 
  group_by(aor, fy, arrest_method_short) %>%
  ggplot(aes(x = fy, fill=arrest_method_short)) +
  geom_bar(stat='count') +
  scale_x_discrete(breaks=seq(2012, 2022, 2)) +
  facet_wrap(~aor) +
  labs(title="Total ICE arrests by arrest method per AOR") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0, hjust=1))

ggplotly(p2)


```

```{r trend_specific_aor}

specific_aor = "SEA"

p4 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30') %>%
  group_by(aor, year_mth, arrest_method_short) %>%
  summarize(n = n()) %>% 
  ggplot(aes(x = year_mth, y = n, fill=arrest_method_short, group=arrest_method_short)) +
  geom_col() +
  geom_vline(aes(xintercept=as.yearmon("2019-06"))) +
  labs(title=paste0("Total arrests by arrest method, ", specific_aor, " AOR"))

ggplotly(p4)

```

### Trends in SEA NCA arrests

```{r trend_specific_aor_method_nca}

specific_aor = "SEA"
specific_method = "Non-Custodial Arrest"

p4 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  group_by(aor, year_mth, arrest_method_short) %>%
  summarize(n = n()) %>% 
  ggplot(aes(x = year_mth, y = n, fill=arrest_method_short, group=arrest_method_short)) +
  geom_col() +
  geom_vline(aes(xintercept=as.yearmon("2019-06"))) +
  geom_vline(aes(xintercept=as.yearmon("2021-11"))) +
  labs(title = "Total ICE arrests",
       subtitle = paste(specific_method, specific_aor, sep=", "))

p4

```

```{r trend_compare_method_nca_highlight_aor}

p1 <- arr %>% 
  filter(!is.na(aor),
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, year_mth, arrest_method_short) %>%
  ggplot(aes(x = year_mth, y = n, color=aor, group=aor)) +
  geom_line() +
  gghighlight(aor == specific_aor) +
  labs(title = "Total ICE arrests per AOR",
       subtitle = paste(specific_method))

p1

```

Most served w/ NTA

```{r sea_nca}

p1 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, year_mth, processing_disposition) %>%
  ggplot(aes(x = year_mth, y = n, fill=processing_disposition, group=processing_disposition)) +
  geom_col() +
  labs(title = paste("Processing disposition,", specific_method, specific_aor))

ggplotly(p1)

```

Landmarks often reflect operational nature of arrest, not location. Recent increase largely "Seattle Non-Detained Docket" and other non-detained categories, compared to categories which suggest street/fugitive operations arrests. Should compare to other non-custodial categories (i.e. "Located").

```{r sea_nca_landmark}

sea_nca_landmarks <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         # arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, apprehension_landmark) %>% 
  arrange(desc(n))

p2 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date > '2016-09-30',
         arrest_method_short == specific_method) %>%
  # mutate(apprehension_landmark = case_when(apprehension_landmark %in% head(sea_nca_landmarks$apprehension_landmark, 10) ~ apprehension_landmark,
  #                                          TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, apprehension_landmark) %>% 
  ggplot(aes(x=year_mth, y=n, fill=apprehension_landmark, group=apprehension_landmark)) +
  geom_col() +
  theme(legend.position = "none")

ggplotly(p2)

```

```{r zoom}

p2 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date > '2020-09-30',
         arrest_method_short == specific_method) %>%
  # mutate(apprehension_landmark = case_when(apprehension_landmark %in% head(sea_nca_landmarks$apprehension_landmark, 10) ~ apprehension_landmark,
  #                                          TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, apprehension_landmark) %>% 
  ggplot(aes(x=year_mth, y=n, fill=apprehension_landmark, group=apprehension_landmark)) +
  geom_col()

ggplotly(p2)

```

Most arrests missing `operation` data but for those that do recent arrests largely associated with "Southwest Border SWB PD".

```{r sea_nca_ops}

sea_nca_operations <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, operation) %>% 
  arrange(desc(n))

p3 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  mutate(operation = case_when(operation %in% head(sea_nca_operations$operation, 10) ~ operation,
                                           TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, operation) %>% 
  ggplot(aes(x=year_mth, y=n, fill=operation, group=operation)) +
  geom_col()

ggplotly(p3)

```

### Trends in SEA CLC arrests

```{r trend_specific_aor_method_clc}

specific_aor = "SEA"
specific_method = "CAP Local Incarceration"

p4 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  group_by(aor, year_mth, arrest_method_short) %>%
  summarize(n = n()) %>% 
  ggplot(aes(x = year_mth, y = n, fill=arrest_method_short, group=arrest_method_short)) +
  geom_col() +
  geom_vline(aes(xintercept=as.yearmon("2019-06"))) +
  geom_vline(aes(xintercept=as.yearmon("2021-11"))) +
  labs(title = "Total ICE arrests",
       subtitle = paste(specific_method, specific_aor, sep=", "))

p4

```

```{r trend_compare_method_clc_highlight_aor}

p1 <- arr %>% 
  filter(!is.na(aor),
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, year_mth, arrest_method_short) %>%
  ggplot(aes(x = year_mth, y = n, color=aor, group=aor)) +
  geom_line() +
  gghighlight(aor == specific_aor) +
  labs(title = "Total ICE arrests per AOR",
       subtitle = paste(specific_method))

p1

```



```{r sea_cap}

p1 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, year_mth, processing_disposition) %>%
  ggplot(aes(x = year_mth, y = n, fill=processing_disposition, group=processing_disposition)) +
  geom_col() +
  labs(title = paste("Processing disposition,", specific_method, specific_aor))

ggplotly(p1)

```


```{r sea_cap_landmark}

sea_cap_landmarks <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         # arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, apprehension_landmark) %>% 
  arrange(desc(n))

p2 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date > '2016-09-30',
         arrest_method_short == specific_method) %>%
  # mutate(apprehension_landmark = case_when(apprehension_landmark %in% head(sea_nca_landmarks$apprehension_landmark, 10) ~ apprehension_landmark,
  #                                          TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, apprehension_landmark) %>% 
  ggplot(aes(x=year_mth, y=n, fill=apprehension_landmark, group=apprehension_landmark)) +
  geom_col() +
  theme(legend.position = "none")

ggplotly(p2)

```

```{r zoom_sea_cap}

p2 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date > '2021-09-30',
         arrest_method_short == specific_method) %>%
  # mutate(apprehension_landmark = case_when(apprehension_landmark %in% head(sea_nca_landmarks$apprehension_landmark, 10) ~ apprehension_landmark,
  #                                          TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, apprehension_landmark) %>% 
  ggplot(aes(x=year_mth, y=n, fill=apprehension_landmark, group=apprehension_landmark)) +
  geom_col()

ggplotly(p2)

```

Most arrests missing `operation` data but for those that do recent arrests largely associated with "Southwest Border SWB PD".

```{r sea_cap_ops}

sea_cap_operations <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  count(aor, operation) %>% 
  arrange(desc(n))

p3 <- arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date >= '2016-10-30',
         arrest_method_short == specific_method) %>%
  mutate(operation = case_when(operation %in% head(sea_nca_operations$operation, 10) ~ operation,
                                           TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, operation) %>% 
  ggplot(aes(x=year_mth, y=n, fill=operation, group=operation)) +
  geom_col()

ggplotly(p3)

```

```{r tab_sea_cap}

arr %>% 
  filter(!is.na(aor),
         aor == specific_aor,
         arrest_date > '2021-09-30',
         arrest_method_short == specific_method) %>%
  # mutate(apprehension_landmark = case_when(apprehension_landmark %in% head(sea_nca_landmarks$apprehension_landmark, 10) ~ apprehension_landmark,
  #                                          TRUE ~ "ALL OTHERS")) %>% 
  count(year_mth, apprehension_landmark)

```

