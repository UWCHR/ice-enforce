---
title: "Descriptive Analysis"
author: "Trung-Anh Nguyen"
date: "1/23/2022"
output: 
  html_document: 
    code_folding: hide
---

```{r setup, include=F, warning=F, message=F}
rm(list = ls())
knitr::opts_chunk$set(warning=F, message=F, cache = T)
options(scipen = 999)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(tidyr)
library(knitr)
library(ggthemes)
library(lubridate)
```

# Arrests

```{r cache=T}
arrests <- read.csv("../../export/output/arrests.csv.gz")
arrests <- arrests %>% filter(aor != "HQ") %>%
  mutate(apprehension_date2 = as.Date(apprehension_date, format = "%m/%d/%Y"),
                              apprehension_year = format(apprehension_date2, "%Y"))
```

```{r}
arrests %>% select(1:8) %>% head() %>% kable(caption = "`arrests` dataframe")

plot <- arrests %>% 
  group_by(apprehension_year) %>%
  summarize(total = n()) 

plot2 <- arrests %>% 
  group_by(apprehension_year, aor) %>%
  summarize(total = n())

plot2 %>% pivot_wider(names_from = apprehension_year, values_from = total) %>% kable(caption = "Total Arrests by AOR 2015-2019")

ggplot(plot, aes(apprehension_year, total, group = 1)) + 
  geom_point() +
  geom_line() +
  labs(x = "Apprehension Year",
       y = "Total Yearly Apprehension",
       title = "Total Arrests Across AOR 2015-2019") +
  theme_few()

#ggplot(plot2, aes(as.numeric(apprehension_year), total, group = aor)) + 
  #geom_line(aes(col = aor)) +
  #scale_x_continuous(limits = c(2015, 2019)) +
  #labs(x = "Apprehension Year",
       #y = "Yearly Apprehension by AOR")

ggplot(plot2, aes(as.numeric(apprehension_year), total, group = aor)) + 
  geom_line(aes(col = aor)) +
  scale_x_continuous(limits = c(2015, 2019)) +
  labs(x = "Apprehension Year",
       y = "Yearly Apprehension by AOR",
       title = "Total Arrests by AOR 2015-2019") +
  facet_wrap(~aor) +
  theme_few() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))
```


```{r fiscalyear}
arrests <- arrests %>% mutate(fy = case_when(apprehension_date2 < "2016-10-01" ~ 2016,
                                                             apprehension_date2 < "2017-10-01" ~ 2017,
                                                             apprehension_date2 < "2018-10-01" ~ 2018,
                                                             apprehension_date2 < "2019-10-01" ~ 2019),
                              apprehension_month = format(apprehension_date2, "%Y-%m"))
 arrests %>% 
  group_by(fy) %>%
  summarize(total = n()) %>%
  ggplot(aes(fy, total, group = 1)) + 
  geom_point() +
  geom_line() +
  labs(x = "Apprehension Year (Fiscal)",
       y = "Total Yearly Apprehension",
       title = "Total Arrests Across AOR FY 2016-2019") +
  theme_few()
 
arrests %>% 
  group_by(fy, aor) %>%
  summarize(total = n()) %>%
  ggplot(aes(as.numeric(fy), total, group = aor)) + 
  geom_line(aes(col = aor)) +
  scale_x_continuous(limits = c(2016, 2019)) +
  labs(x = "Apprehension Year (Fiscal)",
       y = "Yearly Apprehension by AOR",
       title = "Total Arrests by AOR FY 2016-2019") +
  facet_wrap(~aor) +
  theme_few() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

#mutate(quarter = quarter(date, with_year = TRUE, fiscal_start = 10), # Here we extract FY on the fly and lose date functionality
         #fy = stringr::str_sub(quarter, 1, 4)) %>% 
  #group_by(fy)

# Monthly data
arrests_2016 <- arrests %>% filter(fy == 2016) %>%
  group_by(aor, apprehension_month) %>%
  summarize(total = n())          
arrests_2017 <- arrests %>% filter(fy == 2017) %>%
  group_by(aor, apprehension_month) %>%
  summarize(total = n())
arrests_2018 <- arrests %>% filter(fy == 2018) %>%
  group_by(aor, apprehension_month) %>%
  summarize(total = n())
arrests_2019 <- arrests %>% filter(fy == 2019) %>%
  group_by(aor, apprehension_month) %>%
  summarize(total = n())

# Quarterly data
arrests_2016_q <- arrests %>% filter(fy == 2016) %>% 
  mutate(quarter = case_when(apprehension_month < "2016-01" ~ 1,
                             apprehension_month < "2016-04" ~ 2,
                            apprehension_month < "2016-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n())
  
arrests_2017_q <- arrests %>% filter(fy == 2017) %>% 
  mutate(quarter = case_when(apprehension_month < "2017-01" ~ 1,
                             apprehension_month < "2017-04" ~ 2,
                            apprehension_month < "2017-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n())   
  
arrests_2018_q <- arrests %>% filter(fy == 2018) %>% 
  mutate(quarter = case_when(apprehension_month < "2018-01" ~ 1,
                             apprehension_month < "2018-04" ~ 2,
                            apprehension_month < "2018-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) 

arrests_2019_q <- arrests %>% filter(fy == 2019) %>% 
  mutate(quarter = case_when(apprehension_month < "2019-01" ~ 1,
                             apprehension_month < "2019-04" ~ 2,
                            apprehension_month < "2019-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) 
```

```{r apprehension_landmark}
#apprehension_landmark <- arrests %>% group_by(apprehension_landmark) %>% summarize(total = n())
#write.csv(apprehension_landmark, 'apprehension_landmark.csv')

arrests <- arrests %>% mutate(apprehension_landmark2 = 
                                case_when(grepl('NON-SPECIFIC|ARREST AT|ATD|BUREAU OF PRISONS-|FEDCAP-', apprehension_landmark) ~ "Non-specific",
                                          apprehension_landmark %in% c("LICENSING UNIT/STATE POLICE", "287g", "at-large", "California Healthcare Facility", "CALIFORNIA HIGHWAY PATROL", "CAP ACI", "CIS REFERRAL", "FEDERAL DETENTION CENTER (FDC)", "FIELD ARREST", "FTC CI (Federal Transfer Center)", "FTM-JCART", "FTM-VCAS", "FUG - NON FUGITIVE", "FUGITIVE OPERATIONS", "FUGITIVE SOUTH TEAM ARRESTS", "FUGOP", "FUGOPS", "STREET ARREST", "STREET ARRESTS", "U.S. Marshalls Service", "U.S. Marshals", "U.S. Marshals Service", "U.S. MARSHALS SERVICE"< "U.S. PROBATION OFFICE", "UNITED STATES MARSHALL SERVICE", "UNITED STATES PROBATION & PAROLE", "UNITED STATES PROBATION", "US 281 TO FM 493 EXP 83 NORTH TO FM 490", "US DISTRICT COURT", "US MARSHALLS", "US Marshals TF", "USCIS ARREST", "USCIS REFERRALS") ~ "Non-specific",
                                          apprehension_landmark == 'DO NOT USE'  ~ "DO NOT USE",
                                          apprehension_landmark == ''  ~ "NA",
                                          TRUE ~ "Specific"))
#test <- arrests %>% select(apprehension_landmark, apprehension_landmark2)

specificity <- arrests %>% 
  group_by(aor, apprehension_landmark2) %>%
  summarize(total = n()) %>% 
  pivot_wider(names_from = apprehension_landmark2, values_from = total)
  
specificity %>% kable(caption = 'Apprehension landmark specificity by AOR FY2016-2019')

specificity2 <- specificity %>% 
  replace(is.na(.), 0) %>%
  rowwise() %>%
  mutate("Non-specific total" = sum(c_across("NA":"DO NOT USE"))) %>%
  select("Non-specific total", "Specific") %>%
  rowwise() %>%
  mutate("Total" =  sum(c_across("Non-specific total": "Specific"))) %>%
  rowwise() %>% mutate("%specific" = round((Specific/Total), 2))

specificity2 %>% kable(caption = 'Apprehension landmark specificity % by AOR FY2016-2019')
```

```{r}
arrests %>% 
  group_by(apprehension_method) %>%
  summarize(total = n()) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Arrests - Apprehension methods')
```


```{r citizenship}
# by FY
arrests %>% 
  group_by(citizenship, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  head(n=15) %>%
  kable(caption = 'Top 15 countries whose citizens were arrested FY2016-2019')

# by AOR

# by FY-AOR
```

```{r gender}
# by FY
arrests %>% 
  group_by(gender, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Gender makeup among those arrested FY2016-2019')
# by AOR

# by FY-AOR

```

# Encounters

```{r cache=T}
encounters <- read.csv("../../export/output/encounters.csv.gz")
encounters <- encounters %>% filter(aor != "HQ") %>%
  mutate(event_date2 = as.Date(event_date, format = "%m/%d/%Y"),
                              event_year = format(event_date2, "%Y"))
```

```{r}
encounters %>% select(1:7) %>% head() %>% kable(caption = "`encounters` dataframe")

plot_encounters <- encounters %>% 
  group_by(event_year) %>%
  summarize(total = n()) 

plot2_encounters <- encounters %>% 
  group_by(event_year, aor) %>%
  summarize(total = n())

plot2_encounters %>% pivot_wider(names_from = event_year, values_from = total) %>% kable(caption = "Total Encounters by AOR 2015-2019")

ggplot(plot_encounters, aes(event_year, total, group = 1)) + 
  geom_point() +
  geom_line() +
  labs(x = "Year",
       y = "Total Yearly Encounters",
       title = "Total Encounters Across AOR 2015-2019") +
  theme_few()

#ggplot(plot2, aes(as.numeric(apprehension_year), total, group = aor)) + 
  #geom_line(aes(col = aor)) +
  #scale_x_continuous(limits = c(2015, 2019)) +
  #labs(x = "Apprehension Year",
       #y = "Yearly Apprehension by AOR")

ggplot(plot2_encounters, aes(as.numeric(event_year), total, group = aor)) + 
  geom_line(aes(col = aor)) +
  scale_x_continuous(limits = c(2015, 2019)) +
  labs(x = "Year",
       y = "Yearly Encounters by AOR",
       title = "Total Encounters by AOR 2015-2019") +
  facet_wrap(~aor) +
  theme_few() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))
```

```{r fiscalyear_encounters}
encounters <- encounters %>% mutate(fy = case_when(event_date2 < "2016-10-01" ~ 2016,
                                                   event_date2 < "2017-10-01" ~ 2017,
                                                   event_date2 < "2018-10-01" ~ 2018,
                                                   event_date2 < "2019-10-01" ~ 2019),
                              event_month = format(event_date2, "%Y-%m"))
encounters %>% 
  group_by(fy) %>%
  summarize(total = n()) %>%
  ggplot(aes(fy, total, group = 1)) + 
  geom_point() +
  geom_line() +
  labs(x = "Encounter Year (Fiscal)",
       y = "Total Yearly Encounters",
       title = "Total Encounters Across AOR FY 2016-2019") +
  theme_few()
 
encounters %>% 
  group_by(fy, aor) %>%
  summarize(total = n()) %>%
  ggplot(aes(as.numeric(fy), total, group = aor)) + 
  geom_line(aes(col = aor)) +
  scale_x_continuous(limits = c(2016, 2019)) +
  labs(x = "Encounter Year (Fiscal)",
       y = "Yearly Encounters by AOR",
       title = "Total Encounters by AOR FY 2016-2019") +
  facet_wrap(~aor) +
  theme_few() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

# Monthly data
encounters_2016 <- encounters %>% filter(fy == 2016) %>%
  group_by(aor, event_month) %>%
  summarize(total = n())          
encounters_2017 <- encounters %>% filter(fy == 2017) %>%
  group_by(aor, event_month) %>%
  summarize(total = n())
encounters_2018 <- encounters %>% filter(fy == 2018) %>%
  group_by(aor, event_month) %>%
  summarize(total = n())
encounters_2019 <- encounters %>% filter(fy == 2019) %>%
  group_by(aor, event_month) %>%
  summarize(total = n())

# Quarterly data
encounters_2016_q <- encounters %>% filter(fy == 2016) %>% 
  mutate(quarter = case_when(event_month < "2016-01" ~ 1,
                             event_month < "2016-04" ~ 2,
                             event_month < "2016-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n())
  
encounters_2017_q <- encounters %>% filter(fy == 2017) %>% 
  mutate(quarter = case_when(event_month < "2017-01" ~ 1,
                             event_month < "2017-04" ~ 2,
                             event_month < "2017-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n())   
  
encounters_2018_q <- encounters %>% filter(fy == 2018) %>% 
  mutate(quarter = case_when(event_month < "2018-01" ~ 1,
                             event_month < "2018-04" ~ 2,
                             event_month < "2018-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) 

encounters_2019_q <- encounters %>% filter(fy == 2019) %>% 
  mutate(quarter = case_when(event_month < "2019-01" ~ 1,
                             event_month < "2019-04" ~ 2,
                             event_month < "2019-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) 
```

```{r encounters_landmark}
#encounter_landmark <- encounters %>% group_by(landmark) %>% summarize(total = n())
#write.csv(encounter_landmark, 'encounter_landmark.csv')

encounters <- encounters %>% mutate(landmark2 = 
                                case_when(grepl('NON-SPECIFIC|ARREST AT|ATD|BUREAU OF PRISONS-|FEDCAP-', landmark) ~ "Non-specific",
                                          landmark %in% c("LICENSING UNIT/STATE POLICE", "287g", "at-large", "California Healthcare Facility", "CALIFORNIA HIGHWAY PATROL", "CAP ACI", "CIS REFERRAL", "FEDERAL DETENTION CENTER (FDC)", "FIELD ARREST", "FTC CI (Federal Transfer Center)", "FTM-JCART", "FTM-VCAS", "FUG - NON FUGITIVE", "FUGITIVE OPERATIONS", "FUGITIVE SOUTH TEAM ARRESTS", "FUGOP", "FUGOPS", "STREET ARREST", "STREET ARRESTS", "U.S. Marshalls Service", "U.S. Marshals", "U.S. Marshals Service", "U.S. MARSHALS SERVICE"< "U.S. PROBATION OFFICE", "UNITED STATES MARSHALL SERVICE", "UNITED STATES PROBATION & PAROLE", "UNITED STATES PROBATION", "US 281 TO FM 493 EXP 83 NORTH TO FM 490", "US DISTRICT COURT", "US MARSHALLS", "US Marshals TF", "USCIS ARREST", "USCIS REFERRALS") ~ "Non-specific",
                                          landmark == 'DO NOT USE'  ~ "DO NOT USE",
                                          landmark == ''  ~ "NA",
                                          TRUE ~ "Specific"))
#test <- encounters %>% select(landmark, landmark2)

specificity_encounters <- encounters %>% 
  group_by(aor, landmark2) %>%
  summarize(total = n()) %>% 
  pivot_wider(names_from = landmark2, values_from = total)
  
specificity_encounters %>% kable(caption = 'Encounter landmark specificity by AOR FY2016-2019')

specificity_encounters2 <- specificity_encounters %>% 
  replace(is.na(.), 0) %>%
  rowwise() %>%
  mutate("Non-specific total" = sum(c_across("NA":"DO NOT USE"))) %>%
  select("Non-specific total", "Specific") %>%
  rowwise() %>%
  mutate("Total" =  sum(c_across("Non-specific total": "Specific"))) %>%
  rowwise() %>% mutate("%specific" = round((Specific/Total), 2))

specificity_encounters2 %>% kable(caption = 'Encounter landmark specificity % by AOR FY2016-2019')
```



```{r citizenship_encounters}
# by FY
encounters %>% 
  group_by(citizenship, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  head(n=15) %>%
  kable(caption = 'Top 15 countries whose citizens were encountered FY2016-2019')

# by AOR

# by FY-AOR
```

```{r gender_encounters}
# by FY
encounters %>% 
  group_by(gender, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Gender makeup among those encounters FY2016-2019')
# by AOR

# by FY-AOR

```


# Removals

```{r cache=T}
removals <- read.csv("../../export/output/removals.csv.gz", sep = "|")
removals <- removals %>% filter(aor != "HQ") %>%
  mutate(apprehension_date2 = as.Date(apprehension_date, format = "%m/%d/%Y"),
         departed_date2 = as.Date(departed_date, format = "%m/%d/%Y"),
         removal_date2 = as.Date(removal_date, format = "%m/%d/%Y"))
```


```{r}
#sum(is.na(removals$apprehension_date2))
removals %>% select(1:9) %>% head() %>% kable(caption = "`removals` dataframe")

removals <- removals %>% drop_na(apprehension_date2, departed_date2, removal_date2) %>%
  mutate(difference = removal_date2 - apprehension_date2,
         difference2 = removal_date2 - departed_date2,
         fy_removal = case_when(removal_date2 < "2016-10-01" ~ 2016,
                        removal_date2 < "2017-10-01" ~ 2017,
                        removal_date2 < "2018-10-01" ~ 2018,
                        removal_date2 < "2019-10-01" ~ 2019))

#sum(removals$difference2 != 0)

removals %>% 
  select(aor, apprehension_date, departed_date, removal_date, difference, difference2) %>% 
  arrange(difference) %>%
  head(30) %>% kable(caption = "`removals` dataframe sorted by `difference` in ascending order")

removals %>% 
  select(aor, apprehension_date, departed_date, removal_date, difference, difference2) %>% 
  arrange(desc(difference)) %>%
  head(30) %>% kable(caption = "`removals` dataframe sorted by `difference` in descending order")

#removals %>% filter(fy == 2016) %>%
  #group_by(aor) %>%
  #summarize(mean_length_stay = mean(difference))
```

There are 14,235 observations with empty `apprehension_date`. These were removed from the calculations for the difference between removal date and apprehension date. 

There were no observations with empty `departed_date` or `removal_date`. There are differences between these 2 columns--17,890 rows show a non-0 difference in the number of days between departure and removal.

`apprehension_date` seems unreliable with the years going back to 0999 or 1972 with extremely long stays.

```{r}
min(removals$removal_date2)
max(removals$removal_date2)
min(removals$departed_date2)
max(removals$departed_date2)
```

`removal_date` seems like the column that we should use as it falls into the FY 2016-2019 range as we see with the other datasets.

```{r difference2}
removals %>% group_by(aor, fy_removal) %>%
  summarize(avg_length = mean(difference2),
            sd_length = sd(difference2),
            median_length = median(difference2),
            min_length = min(difference2),
            max_length = max(difference2)) %>%
  kable(caption = 'Summary statistics of difference in length between departed and removal dates')
```

```{r}
removals %>% group_by(aor, fy_removal) %>%
  summarize(count = n()) %>%
  pivot_wider(names_from = fy_removal, values_from = count) %>%
  kable(caption = 'Number of removals by FY 2016-2019 (by removal_date)')
```


```{r citizenship_removals}
# by FY
removals %>% 
  group_by(citizenship, fy_removal) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy_removal, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  head(n=15) %>%
  kable(caption = 'Top 15 countries whose citizens were removed FY2016-2019')

# by AOR

# by FY-AOR
```

```{r gender_removals}
# by FY
removals %>% 
  group_by(gender, fy_removal) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy_removal, values_from = total) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Gender makeup among those removed FY2016-2019')
# by AOR

# by FY-AOR

```
