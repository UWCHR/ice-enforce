---
title: "Descriptive Analysis"
author: "Trung-Anh Nguyen"
date: "1/23/2022"
output: 
  html_document: 
    code_folding: hide
---

```{r setup, include=F, warning=F, message=F}
rm(list = ls())
knitr::opts_chunk$set(warning=F, message=F, cache = T)
options(scipen = 999)

pacman::p_load('ggplot2', 'RColorBrewer', 'tidyr', 'knitr', 'ggthemes', 'lubridate', 'dplyr', 'here')

```

# Arrests

```{r cache=T}
file_in <- here::here('us', 'export', 'output', 'arrests.csv.gz')
arrests <- read.csv(file_in)
arrests <- arrests %>% filter(aor != "HQ") %>%
  mutate(apprehension_date2 = as.Date(apprehension_date, format = "%m/%d/%Y"),
                              apprehension_year = format(apprehension_date2, "%Y"))
```

## Trends in arrest numbers

```{r fiscalyear}
arrests <- arrests %>% mutate(fy = case_when(apprehension_date2 < "2016-10-01" ~ 2016,
                                                             apprehension_date2 < "2017-10-01" ~ 2017,
                                                             apprehension_date2 < "2018-10-01" ~ 2018,
                                                             apprehension_date2 < "2019-10-01" ~ 2019),
                              apprehension_month = format(apprehension_date2, "%m"),
                              apprehension_month_y = format(apprehension_date2, "%Y-%m"),
                              month = month(apprehension_date2))
arrests %>% 
  group_by(fy) %>%
  summarize(total = n()) %>%
  ggplot(aes(fy, total, group = 1)) + 
  geom_point() +
  geom_line() +
  labs(x = "Apprehension Year (Fiscal)",
       y = "Total Yearly Apprehension",
       title = "Total Arrests Across AOR FY 2016-2019") +
  theme_few()

arrests %>% 
  group_by(month, fy) %>%
  summarize(total = n()) %>%
  mutate(Year = factor(fy)) %>%
  mutate(Month = factor(month,
                        levels = c(10:12, 1:9),
                        labels = c(month.abb[10:12], month.abb[1:9]))) %>%
  dplyr::filter(!(Year == 2019 & Month == "Sep")) %>%
  ggplot(aes(x = Month, y = total, color = Year, group = Year)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette="Dark2") +
  theme_few() +
  theme(legend.position="bottom") +
  labs(color = "FY",
       title = "Monthly Arrests Across AOR FY 2016-2019",
       y = "Total Arrests")
 
arrests %>% 
  group_by(fy, aor) %>%
  summarize(total = n()) %>%
  ggplot(aes(as.numeric(fy), total, group = aor)) + 
  geom_line(aes(col = aor)) +
  scale_x_continuous(limits = c(2016, 2019)) +
  labs(x = "Apprehension Year (Fiscal)",
       y = "Yearly Apprehension by AOR",
       title = "Total Arrests by AOR FY 2016-2019") +
  facet_wrap(~aor) +
  theme_few() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))


yearly_change <- arrests %>% 
  group_by(aor, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) 

colnames(yearly_change) <- c("aor", "y_2016", "y_2017", "y_2018", "y_2019")

yearly_change <- yearly_change %>% rowwise() %>% 
  mutate(pct_change_17 = round(((y_2017-y_2016)/y_2016) * 100, 2),
         pct_change_18 = round(((y_2018-y_2017)/y_2017) * 100, 2),
         pct_change_19 = round(((y_2019-y_2018)/y_2018) * 100, 2))

yearly_change %>% kable(caption = "Yearly % change in arrests by AOR")

yearly_change %>% select(aor, 6:8) %>%
  pivot_longer(cols = pct_change_17:pct_change_19, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Yearly % change in arrests by AOR") +
  theme_few()
```


Consistent trend across all AORs: upward trend in arrests number from 2016-2018 and then a drop in 2019.

```{r quarterly}
# Quarterly data
arrests_2016_q <- arrests %>% filter(fy == 2016) %>% 
  mutate(quarter = case_when(apprehension_month_y < "2016-01" ~ 1,
                             apprehension_month_y < "2016-04" ~ 2,
                            apprehension_month_y < "2016-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(arrests_2016_q) <- c("aor", "q1", "q2", "q3", "q4")

arrests_2016_q <- arrests_2016_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

arrests_2016_q %>% kable(caption = "Quarterly % change in arrests by AOR in FY 2016")

arrests_2016_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in arrests by AOR in FY 2016") +
  theme_few()
  
arrests_2017_q <- arrests %>% filter(fy == 2017) %>% 
  mutate(quarter = case_when(apprehension_month_y < "2017-01" ~ 1,
                             apprehension_month_y < "2017-04" ~ 2,
                            apprehension_month_y < "2017-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(arrests_2017_q) <- c("aor", "q1", "q2", "q3", "q4")

arrests_2017_q <- arrests_2016_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

arrests_2017_q %>% kable(caption = "Quarterly % change in arrests by AOR in FY 2017")

arrests_2017_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in arrests by AOR in FY 2017") +
  theme_few()

  
arrests_2018_q <- arrests %>% filter(fy == 2018) %>% 
  mutate(quarter = case_when(apprehension_month_y < "2018-01" ~ 1,
                             apprehension_month_y < "2018-04" ~ 2,
                            apprehension_month_y < "2018-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(arrests_2018_q) <- c("aor", "q1", "q2", "q3", "q4")

arrests_2018_q <- arrests_2018_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

arrests_2018_q %>% kable(caption = "Quarterly % change in arrests by AOR in FY 2018")

arrests_2018_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in arrests by AOR in FY 2018") +
  theme_few()

arrests_2019_q <- arrests %>% filter(fy == 2019) %>% 
  mutate(quarter = case_when(apprehension_month_y < "2019-01" ~ 1,
                             apprehension_month_y < "2019-04" ~ 2,
                            apprehension_month_y < "2019-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(arrests_2019_q) <- c("aor", "q1", "q2", "q3", "q4")

arrests_2019_q <- arrests_2019_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

arrests_2019_q %>% kable(caption = "Quarterly % change in arrests by AOR in FY 2019")

arrests_2019_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in arrests by AOR in FY 2019") +
  theme_few()
```

## Breakdown of arrest landmark, method, citizenship, and gender

```{r apprehension_landmark}
#apprehension_landmark <- arrests %>% group_by(apprehension_landmark) %>% summarize(total = n())
#write.csv(apprehension_landmark, 'apprehension_landmark.csv')

arrests <- arrests %>% mutate(apprehension_landmark2 = 
                                case_when(grepl('NON-SPECIFIC|ARREST AT|ATD|BUREAU OF PRISONS-|FEDCAP-', apprehension_landmark) ~ "Non-specific",
                                          apprehension_landmark %in% c("LICENSING UNIT/STATE POLICE", "287g", "at-large", "California Healthcare Facility", "CALIFORNIA HIGHWAY PATROL", "CAP ACI", "CIS REFERRAL", "FEDERAL DETENTION CENTER (FDC)", "FIELD ARREST", "FTC CI (Federal Transfer Center)", "FTM-JCART", "FTM-VCAS", "FUG - NON FUGITIVE", "FUGITIVE OPERATIONS", "FUGITIVE SOUTH TEAM ARRESTS", "FUGOP", "FUGOPS", "STREET ARREST", "STREET ARRESTS", "U.S. Marshalls Service", "U.S. Marshals", "U.S. Marshals Service", "U.S. MARSHALS SERVICE"< "U.S. PROBATION OFFICE", "UNITED STATES MARSHALL SERVICE", "UNITED STATES PROBATION & PAROLE", "UNITED STATES PROBATION", "US 281 TO FM 493 EXP 83 NORTH TO FM 490", "US DISTRICT COURT", "US MARSHALLS", "US Marshals TF", "USCIS ARREST", "USCIS REFERRALS") ~ "Non-specific",
                                          apprehension_landmark == 'DO NOT USE'  ~ "DO NOT USE",
                                          apprehension_landmark == ''  ~ "NA",
                                          TRUE ~ "Specific"))
#test <- arrests %>% select(apprehension_landmark, apprehension_landmark2)

specificity <- arrests %>% 
  group_by(aor, apprehension_landmark2) %>%
  summarize(total = n()) %>% 
  pivot_wider(names_from = apprehension_landmark2, values_from = total)
  
specificity %>% kable(caption = 'Apprehension landmark specificity by AOR FY2016-2019')

specificity2 <- specificity %>% 
  replace(is.na(.), 0) %>%
  rowwise() %>%
  mutate("Non-specific total" = sum(c_across("NA":"DO NOT USE"))) %>%
  select("Non-specific total", "Specific") %>%
  rowwise() %>%
  mutate("Total" =  sum(c_across("Non-specific total": "Specific"))) %>%
  rowwise() %>% mutate("%specific" = round((Specific/Total), 2))

specificity2 %>% kable(caption = 'Apprehension landmark specificity % by AOR FY2016-2019')
```

```{r}
arrests %>% 
  group_by(apprehension_method) %>%
  summarize(total = n()) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Arrests - Apprehension methods')
```


```{r citizenship}
# by FY
arrests %>% 
  group_by(citizenship, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  head(n=15) %>%
  kable(caption = 'Top 15 countries whose citizens were arrested FY2016-2019')

# by AOR

# by FY-AOR
```

```{r gender}
# by FY
arrests %>% 
  group_by(gender, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Gender makeup among those arrested FY2016-2019')
# by AOR

# by FY-AOR

```

# Encounters

```{r cache=T}
file_in <- here::here('us', 'export', 'output', 'encounters.csv.gz')
encounters <- read.csv(file_in)
encounters <- encounters %>% filter(aor != "HQ") %>%
  mutate(event_date2 = as.Date(event_date, format = "%m/%d/%Y"),
                              event_year = format(event_date2, "%Y"))
```

## Trends in encounter numbers

```{r fiscalyear_encounters}
encounters <- encounters %>% mutate(fy = case_when(event_date2 < "2016-10-01" ~ 2016,
                                                   event_date2 < "2017-10-01" ~ 2017,
                                                   event_date2 < "2018-10-01" ~ 2018,
                                                   event_date2 < "2019-10-01" ~ 2019),
                              event_month = format(event_date2, "%m"),
                              event_month2 = format(event_date2, "%Y-%m"),
                              month = month(event_date2))
encounters %>% 
  group_by(fy) %>%
  summarize(total = n()) %>%
  ggplot(aes(fy, total, group = 1)) + 
  geom_point() +
  geom_line() +
  labs(x = "Encounter Year (Fiscal)",
       y = "Total Yearly Encounters",
       title = "Total Encounters Across AOR FY 2016-2019") +
  theme_few()

encounters %>% 
  group_by(month, fy) %>%
  summarize(total = n()) %>%
  mutate(Year = factor(fy)) %>%
  mutate(Month = factor(month,
                        levels = c(10:12, 1:9),
                        labels = c(month.abb[10:12], month.abb[1:9]))) %>%
  dplyr::filter(!(Year == 2019 & Month == "Sep")) %>%
  ggplot(aes(x = Month, y = total, color = Year, group = Year)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette="Dark2") +
  theme_few() +
  theme(legend.position="bottom") +
  labs(color = "FY",
       title = "Total Monthly Encounters Across AOR FY 2016-2019",
       y = "Total Encounters")
 
encounters %>% 
  group_by(fy, aor) %>%
  summarize(total = n()) %>%
  ggplot(aes(as.numeric(fy), total, group = aor)) + 
  geom_line(aes(col = aor)) +
  scale_x_continuous(limits = c(2016, 2019)) +
  labs(x = "Encounter Year (Fiscal)",
       y = "Yearly Encounters by AOR",
       title = "Total Encounters by AOR FY 2016-2019") +
  facet_wrap(~aor) +
  theme_few() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

yearly_change_encounters <- encounters %>% 
  group_by(aor, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) 

colnames(yearly_change_encounters) <- c("aor", "y_2016", "y_2017", "y_2018", "y_2019")

yearly_change_encounters <- yearly_change_encounters %>% rowwise() %>% 
  mutate(pct_change_17 = round(((y_2017-y_2016)/y_2016) * 100, 2),
         pct_change_18 = round(((y_2018-y_2017)/y_2017) * 100, 2),
         pct_change_19 = round(((y_2019-y_2018)/y_2018) * 100, 2))

yearly_change_encounters %>% kable(caption = "Yearly % change in encounters by AOR")

yearly_change_encounters %>% select(aor, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Yearly % change in Encounters by AOR") +
  theme_few()
```

``` {r encounters_quarterly}

# Quarterly data
encounters_2016_q <- encounters %>% filter(fy == 2016) %>% 
  mutate(quarter = case_when(event_month2 < "2016-01" ~ 1,
                             event_month2 < "2016-04" ~ 2,
                             event_month2 < "2016-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(encounters_2016_q) <- c("aor", "q1", "q2", "q3", "q4")

encounters_2016_q <- encounters_2016_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

encounters_2016_q %>% kable(caption = "Quarterly % change in encounters by AOR in FY 2016")

encounters_2016_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in encounters by AOR in FY 2016") +
  theme_few()
  
encounters_2017_q <- encounters %>% filter(fy == 2017) %>% 
  mutate(quarter = case_when(event_month2 < "2017-01" ~ 1,
                             event_month2 < "2017-04" ~ 2,
                             event_month2 < "2017-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(encounters_2017_q) <- c("aor", "q1", "q2", "q3", "q4")

encounters_2017_q <- encounters_2017_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

encounters_2017_q %>% kable(caption = "Quarterly % change in encounters by AOR in FY 2017")

encounters_2017_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in encounters by AOR in FY 2017") +
  theme_few()
  
encounters_2018_q <- encounters %>% filter(fy == 2018) %>% 
  mutate(quarter = case_when(event_month2 < "2018-01" ~ 1,
                             event_month2 < "2018-04" ~ 2,
                             event_month2 < "2018-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(encounters_2018_q) <- c("aor", "q1", "q2", "q3", "q4")

encounters_2018_q <- encounters_2018_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

encounters_2018_q %>% kable(caption = "Quarterly % change in encounters by AOR in FY 2018")

encounters_2018_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in encounters by AOR in FY 2018") +
  theme_few()

encounters_2019_q <- encounters %>% filter(fy == 2019) %>% 
  mutate(quarter = case_when(event_month2 < "2019-01" ~ 1,
                             event_month2 < "2019-04" ~ 2,
                             event_month2 < "2019-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(encounters_2019_q) <- c("aor", "q1", "q2", "q3", "q4")

encounters_2019_q <- encounters_2019_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

encounters_2019_q %>% kable(caption = "Quarterly % change in encounters by AOR in FY 2019")

encounters_2019_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in encounters by AOR in FY 2019") +
  theme_few()
```


## Breakdown of encounter landmark, citizenship, and gender

```{r encounters_landmark}
#encounter_landmark <- encounters %>% group_by(landmark) %>% summarize(total = n())
#write.csv(encounter_landmark, 'encounter_landmark.csv')

encounters <- encounters %>% mutate(landmark2 = 
                                case_when(grepl('NON-SPECIFIC|ARREST AT|ATD|BUREAU OF PRISONS-|FEDCAP-', landmark) ~ "Non-specific",
                                          landmark %in% c("LICENSING UNIT/STATE POLICE", "287g", "at-large", "California Healthcare Facility", "CALIFORNIA HIGHWAY PATROL", "CAP ACI", "CIS REFERRAL", "FEDERAL DETENTION CENTER (FDC)", "FIELD ARREST", "FTC CI (Federal Transfer Center)", "FTM-JCART", "FTM-VCAS", "FUG - NON FUGITIVE", "FUGITIVE OPERATIONS", "FUGITIVE SOUTH TEAM ARRESTS", "FUGOP", "FUGOPS", "STREET ARREST", "STREET ARRESTS", "U.S. Marshalls Service", "U.S. Marshals", "U.S. Marshals Service", "U.S. MARSHALS SERVICE"< "U.S. PROBATION OFFICE", "UNITED STATES MARSHALL SERVICE", "UNITED STATES PROBATION & PAROLE", "UNITED STATES PROBATION", "US 281 TO FM 493 EXP 83 NORTH TO FM 490", "US DISTRICT COURT", "US MARSHALLS", "US Marshals TF", "USCIS ARREST", "USCIS REFERRALS") ~ "Non-specific",
                                          landmark == 'DO NOT USE'  ~ "DO NOT USE",
                                          landmark == ''  ~ "NA",
                                          TRUE ~ "Specific"))
#test <- encounters %>% select(landmark, landmark2)

specificity_encounters <- encounters %>% 
  group_by(aor, landmark2) %>%
  summarize(total = n()) %>% 
  pivot_wider(names_from = landmark2, values_from = total)
  
specificity_encounters %>% kable(caption = 'Encounter landmark specificity by AOR FY2016-2019')

specificity_encounters2 <- specificity_encounters %>% 
  replace(is.na(.), 0) %>%
  rowwise() %>%
  mutate("Non-specific total" = sum(c_across("NA":"DO NOT USE"))) %>%
  select("Non-specific total", "Specific") %>%
  rowwise() %>%
  mutate("Total" =  sum(c_across("Non-specific total": "Specific"))) %>%
  rowwise() %>% mutate("%specific" = round((Specific/Total), 2))

specificity_encounters2 %>% kable(caption = 'Encounter landmark specificity % by AOR FY2016-2019')
```



```{r citizenship_encounters}
# by FY
encounters %>% 
  group_by(citizenship, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  head(n=15) %>%
  kable(caption = 'Top 15 countries whose citizens were encountered FY2016-2019')

# by AOR

# by FY-AOR
```

```{r gender_encounters}
# by FY
encounters %>% 
  group_by(gender, fy) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Gender makeup among those encounters FY2016-2019')
# by AOR

# by FY-AOR

```


# Removals

```{r cache=T}
file_in <- here::here('us', 'export', 'output', 'removals.csv.gz')
removals <- read.csv(file_in, sep = "|")
removals <- removals %>% filter(aor != "HQ") %>%
  mutate(apprehension_date2 = as.Date(apprehension_date, format = "%m/%d/%Y"),
         departed_date2 = as.Date(departed_date, format = "%m/%d/%Y"),
         removal_date2 = as.Date(removal_date, format = "%m/%d/%Y"),
         removal_month = format(removal_date2, "%m"))
```

```{r}
removals <- removals %>% drop_na(apprehension_date2, departed_date2, removal_date2) %>%
  mutate(difference = removal_date2 - apprehension_date2,
         difference2 = removal_date2 - departed_date2,
         fy_removal = case_when(removal_date2 < "2016-10-01" ~ 2016,
                        removal_date2 < "2017-10-01" ~ 2017,
                        removal_date2 < "2018-10-01" ~ 2018,
                        removal_date2 < "2019-10-01" ~ 2019),
         removal_month_y = format(removal_date2, "%Y-%m"))

#removals %>% 
  #select(aor, apprehension_date, departed_date, removal_date, difference, difference2) %>% 
  #arrange(difference) %>%
  #head(30) %>% kable(caption = "`removals` dataframe sorted by `difference` in ascending order")

#removals %>% 
  #select(aor, apprehension_date, departed_date, removal_date, difference, difference2) %>% 
  #arrange(desc(difference)) %>%
  #head(30) %>% kable(caption = "`removals` dataframe sorted by `difference` in descending order")
```

There are 14,235 observations with empty `apprehension_date`. These were removed from the calculations for the difference between removal date and apprehension date. 

There were no observations with empty `departed_date` or `removal_date`. There are differences between these 2 columns--17,890 rows show a non-0 difference in the number of days between departure and removal.

`apprehension_date` seems unreliable with the years going back to 0999 or 1972 with extremely long stays.

`removal_date` seems like the column that we should use as it falls into the FY 2016-2019 range as we see with the other datasets.

```{r difference2}
#removals %>% group_by(aor, fy_removal) %>%
  #summarize(avg_length = mean(difference2),
            #sd_length = sd(difference2),
            #median_length = median(difference2),
            #min_length = min(difference2),
            #max_length = max(difference2)) %>%
  #kable(caption = 'Summary statistics of difference in length between departed and removal dates')
```


## Trends in removal numbers

```{r}
#removals %>% group_by(aor, fy_removal) %>%
  #summarize(count = n()) %>%
  #pivot_wider(names_from = fy_removal, values_from = count) %>%
  #kable(caption = 'Number of removals by FY 2016-2019 (by removal_date)')

removals %>% 
  mutate(month = month(removal_date2)) %>%
  group_by(fy_removal, month) %>%
  summarize(total = n()) %>%
  mutate(Year = factor(fy_removal)) %>%
  mutate(Month = factor(month,
                        levels = c(10:12, 1:9),
                        labels = c(month.abb[10:12], month.abb[1:9]))) %>%
  dplyr::filter(!(Year == 2019 & Month == "Sep")) %>%
  ggplot(aes(x = Month, y = total, color = Year, group = Year)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette="Dark2") +
  theme_few() +
  theme(legend.position="bottom") +
  labs(color = "FY",
       title = "Total monthly removals FY 2016-2019",
       y = "Total Removals")

yearly_change_removals <- removals %>% 
  group_by(aor, fy_removal) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy_removal, values_from = total) 

colnames(yearly_change_removals) <- c("aor", "y_2016", "y_2017", "y_2018", "y_2019")

yearly_change_removals <- yearly_change_removals %>% rowwise() %>% 
  mutate(pct_change_17 = round(((y_2017-y_2016)/y_2016) * 100, 2),
         pct_change_18 = round(((y_2018-y_2017)/y_2017) * 100, 2),
         pct_change_19 = round(((y_2019-y_2018)/y_2018) * 100, 2))

yearly_change_removals %>% kable(caption = "Yearly % change in removals by AOR")
yearly_change_removals %>% select(aor, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Yearly % change in removals by AOR") +
  theme_few()
```

```{r removals_quarterly}
# Quarterly data
removals_2016_q <- removals %>% filter(fy_removal == 2016) %>% 
  mutate(quarter = case_when(removal_month_y < "2016-01" ~ 1,
                             removal_month_y < "2016-04" ~ 2,
                             removal_month_y < "2016-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(removals_2016_q) <- c("aor", "q1", "q2", "q3", "q4")

removals_2016_q <- removals_2016_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

removals_2016_q %>% kable(caption = "Quarterly % change in removals by AOR in FY 2016")

removals_2016_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in removals by AOR in FY 2016") +
  theme_few()
  
removals_2017_q <- removals %>% filter(fy_removal == 2017) %>% 
  mutate(quarter = case_when(removal_month_y < "2017-01" ~ 1,
                             removal_month_y < "2017-04" ~ 2,
                             removal_month_y < "2017-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(removals_2017_q) <- c("aor", "q1", "q2", "q3", "q4")

removals_2017_q <- removals_2016_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

removals_2017_q %>% kable(caption = "Quarterly % change in removals by AOR in FY 2017")

removals_2017_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in removals by AOR in FY 2017") +
  theme_few()

  
removals_2018_q <- removals %>% filter(fy_removal == 2018) %>% 
  mutate(quarter = case_when(removal_month_y < "2018-01" ~ 1,
                             removal_month_y < "2018-04" ~ 2,
                             removal_month_y < "2018-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(removals_2018_q) <- c("aor", "q1", "q2", "q3", "q4")

removals_2018_q <- removals_2018_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

removals_2018_q %>% kable(caption = "Quarterly % change in removals by AOR in FY 2018")

removals_2018_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in removals by AOR in FY 2018") +
  theme_few()

removals_2019_q <- removals %>% filter(fy_removal == 2019) %>% 
  mutate(quarter = case_when(removal_month_y < "2019-01" ~ 1,
                             removal_month_y < "2019-04" ~ 2,
                             removal_month_y < "2019-07" ~ 3,
                             TRUE ~ 4)) %>%
  group_by(aor, quarter) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = quarter, values_from = total) 

colnames(removals_2019_q) <- c("aor", "q1", "q2", "q3", "q4")

removals_2019_q <- removals_2019_q %>% rowwise() %>% 
  mutate(pct_change_q2 = round(((q2-q1)/q1) * 100, 2),
         pct_change_q3 = round(((q3-q2)/q2) * 100, 2),
         pct_change_q4 = round(((q4-q3)/q3) * 100, 2))

removals_2019_q %>% kable(caption = "Quarterly % change in removals by AOR in FY 2019")

removals_2019_q %>% select(1, 6:8) %>%
  pivot_longer(cols = 2:4, names_to = "Type", values_to = "Value") %>%
  ggplot(aes(x = aor, y = Value)) + geom_bar(stat = "identity") + facet_wrap(~Type) + 
  scale_y_continuous(labels = scales::percent_format(scale = 1)) +
  coord_flip() +
  labs(title = "Quarterly % change in removals by AOR in FY 2019") +
  theme_few()
```

## Breakdown of removals in terms of citizenship and gender

```{r citizenship_removals}
# by FY
removals %>% 
  group_by(citizenship, fy_removal) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy_removal, values_from = total) %>%
  replace(is.na(.), 0) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  head(n=15) %>%
  kable(caption = 'Top 15 countries whose citizens were removed FY2016-2019')

# by AOR

# by FY-AOR
```

```{r gender_removals}
# by FY
removals %>% 
  group_by(gender, fy_removal) %>%
  summarize(total = n()) %>%
  pivot_wider(names_from = fy_removal, values_from = total) %>%
  mutate(total = sum(c_across('2016':'2019'))) %>%
  arrange(desc(total)) %>%
  kable(caption = 'Gender makeup among those removed FY2016-2019')
# by AOR

# by FY-AOR

```




