---
title: "ICE ERO-LESA enforcement actions, FY12-23YTD"
author: "UWCHR"
date: "2024-05-31"
output:
    html_document:
        html_preview: true
        toc: true
        toc_depth: 3
        toc_float: true
        code_folding: hide
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

options(scipen = 1000000)

library(pacman)

p_load(here, tidyverse, zoo, lubridate, ggplot2, plotly, gghighlight, sf, tigris, ggrepel, ggmap, tidygeocoder, viridis)

```

# ICE ERO-LESA enforcement actions: Data overview

This notebook presents a national overview of U.S. Immigration and Customs Enforcement (ICE) Enforcement and Removal Operations (ERO) Law Enforcement Systems and Analysis Division (LESA) data regarding nationwide encounters, arrests, and removals obtained by the University of Washington pursuant to FOIA request 2022-ICFO-09023.

## Encounters

```{r load_encounters, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# ENCOUNTERS DATA

enc <- read_delim(here('analyze', 'input', 'ice_encounters_fy12-23ytd.csv.gz'), delim='|',
                  col_types = cols(aor = col_factor(),
                                   event_date = col_character(),
                                   landmark = col_character(),
                                   operation = col_factor(),
                                   processing_disposition = col_factor(),
                                   citizenship_country = col_factor(),
                                   gender = col_factor(),
                                   hashid = col_character(),
                                   id = col_number()),
                  show_col_types = FALSE)

redacted <- c('encounter_threat_level', 'alien_file_number')
redacted_text <- paste0('`', paste(unlist(redacted), collapse = '`, `'), '`')

enc <- enc %>% 
  dplyr::select(-redacted)

enc <- enc %>% 
  mutate(event_date = as_date(event_date, format="%m/%d/%Y"),
         year = year(event_date),
         month = month(event_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(event_date),
         fy = substr(quarter(event_date, fiscal_start=10, type="year.quarter"), 1,4),
         gender = toupper(gender),
         operation = toupper(operation),
         processing_disposition = toupper(processing_disposition),
         citizenship_country = toupper(citizenship_country))

# glimpse(enc)

```

An encounter occurs when an individual is subjected to revision of admissibility/removability by ICE, and may or may not lead to an arrest. The encounters dataset (`enc`) includes `r nrow(enc)` observations of `r length(enc)` variables; `r length(redacted)` fully redacted fields (`r redacted_text`) are dropped from analysis.

## Arrests

```{r load_arrests, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# ARRESTS DATA

arr <- read_delim(here('analyze', 'input', 'ice_arrests_fy12-23ytd.csv.gz'), delim='|',
                  col_types = cols(aor = col_factor(),
                                  arrest_date = col_date(format="%m/%d/%Y"),
                                  departed_date = col_date(format="%m/%d/%Y"),
                                  apprehension_landmark = col_factor(),
                                  arrest_method = col_factor(),
                                  operation = col_factor(),
                                  processing_disposition = col_factor(),
                                  citizenship_country = col_factor(),
                                  gender = col_factor(),
                                  case_closed_date = col_date(format="%m/%d/%Y"),
                                  id = col_integer(),
                                  hashid = col_character()
                                  )) 

redacted <- c('removal_threat_level', 'apprehension_threat_level', 'alien_file_number')
redacted_text <- paste0('`', paste(unlist(redacted), collapse = '`, `'), '`')

arr <- arr %>% 
  dplyr::select(-all_of(redacted))

arr <- arr %>% 
  mutate(arrest_date = as_date(arrest_date, format="%m/%d/%Y"),
         year = year(arrest_date),
         month = month(arrest_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(arrest_date),
         fy = as.factor(substr(quarter(arrest_date, fiscal_start=10, type="year.quarter"), 1,4)),
         citizenship_country = as.factor(toupper(citizenship_country)))

```

An arrest occurs when an individual is taken into custody by ICE and removal proceedings initiated against them. The arrests dataset (`arr`) includes `r nrow(arr)` observations of `r length(arr)` variables; `r length(redacted)` fully redacted fields (`r redacted_text`) are dropped from analysis.

## Removals

```{r load_removals, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# REMOVALS DATA

pd_dict <- read_delim(here('share', 'hand', 'processing_disp.csv'), delim='|')

rem <- read_delim(here('analyze', 'input', 'ice_removals_fy12-23ytd.csv.gz'), delim='|',
                  col_types = cols(aor = col_character(),
                                   arrest_date = col_date(format="%m/%d/%Y"),
                                  departed_date = col_date(format="%m/%d/%Y"),
                                  case_close_date = col_date(format="%m/%d/%Y"),
                                  removal_date = col_date(format="%m/%d/%Y"),
                                  apprehension_method_code = col_character(),
                                  processing_disposition_code = col_factor(),
                                  citizenship_country = col_factor(),
                                  gender = col_factor(),
                                  final_charge_section = col_factor(),
                                  id = col_integer(),
                                  hashid = col_character()
                                  )) 

# glimpse(rem)

redacted <- c('removal_threat_level', 'alien_file_number')
redacted_text <- paste0('`', paste(unlist(redacted), collapse = '`, `'), '`')

rem <- rem %>% 
  dplyr::select(-redacted, -case_closed_date)

rem <- rem %>% 
  mutate(year = year(departed_date),
         month = month(departed_date, label=TRUE, abbr=TRUE),
         year_mth = zoo::as.yearmon(departed_date),
         processing_disp = toupper(coalesce(processing_disposition_code, processing_disposition)),
         fy =substr(quarter(departed_date, fiscal_start=10, type="year.quarter"), 1,4))

rem <- left_join(rem, pd_dict, by=c('processing_disp' = 'processing_disposition_raw'))

```

A removal occurs when an individual is issued a final order of removal. The removals dataset (`rem`) includes `r nrow(rem)` observations of `r length(rem)` variables; `r length(redacted)` fully redacted fields (`r redacted_text`) are dropped from analysis.

```{r load_supplemental, echo=FALSE, message=FALSE, warning=FALSE, include=TRUE}

# SUPPLEMENTAL DATA

# AOR geographic boundaries by county
county_aor <- read_delim(here('share', 'hand', 'county_aor.csv'), delim = ',')
aor_field_office <- read_delim(here('share', 'hand', 'aor_ero_field_office.csv'), delim = ',')

# Select AOR-level demographics obtained via `tidycensus`
demog <- read_delim(here('analyze', 'input', 'aor_demog_indicators.csv.gz'), delim='|') %>%
  arrange(aor, year)

# Google mapping API
ggkey = Sys.getenv("GOOGLEGEOCODE_API_KEY")
register_google(key = ggkey)

# Scale for per capita calculations
pc_scale = 100000

```

# Basic comparative analysis

## Total enforcement actions per FY

```{r fy_total, echo=FALSE, message=FALSE, include=TRUE}

enc_fy <- enc %>% 
  filter(event_date <= "2022-09-30") %>% 
  group_by(fy) %>% 
  summarize(n_encounters = n())

arr_fy <- arr %>% 
  filter(arrest_date <= "2022-09-30") %>% 
  group_by(fy) %>% 
  summarize(n_arrests = n())

rem_fy <- rem %>% 
  filter(departed_date <= "2022-09-30") %>% 
  group_by(fy) %>% 
  summarize(n_removals = n())

dat <- left_join(enc_fy, arr_fy, by='fy') %>% 
  left_join(rem_fy, by='fy')

p1 <- dat %>%
  pivot_longer(cols=-c('fy')) %>% 
  ggplot(aes(x = as.factor(fy), y=value, color=name, group=name)) +
  geom_line() +
  labs(title = "Total ICE enforcement events per FY") +
  xlab('') +
  ylab("Value") +
  ylim(0, NA)

ggplotly(p1)

```

## Enforcement by AOR

```{r enforce_by_aor, echo=FALSE, message=FALSE, include=TRUE}

enc_fy_aor <- enc %>% 
  filter(event_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n_encounters = n()) %>% 
  mutate(fy = as.numeric(as.character(fy))) %>% 
  ungroup()

arr_fy_aor <- arr %>% 
  filter(arrest_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n_arrests = n()) %>% 
  mutate(fy = as.numeric(as.character(fy))) %>% 
  ungroup()

rem_fy_aor <- rem %>% 
  filter(departed_date <= "2022-09-30") %>% 
  group_by(fy, aor) %>% 
  summarize(n_removals = n()) %>% 
  mutate(fy = as.numeric(as.character(fy))) %>% 
  ungroup()

dat <- left_join(enc_fy_aor, arr_fy_aor, by=c('fy', 'aor')) %>% 
  left_join(rem_fy_aor, by=c('fy', 'aor'))

dat <- dat %>% 
  mutate(diff_enc_arr = n_encounters - n_arrests,
         diff_arr_rem = n_arrests - n_removals)

p1 <- dat %>%
  filter(!is.na(aor)) %>% 
  dplyr::select(-contains('diff')) %>% 
  pivot_longer(cols=-c('fy', 'aor')) %>% 
  ggplot(aes(x = as.factor(fy), y=value, color=name, group=name)) +
  geom_line() +
  # scale_y_log10() +
  scale_x_discrete(breaks=seq(2013,2024,4)) +
  labs(title = "Total ICE enforcement events per FY") +
  facet_wrap(~aor) +
  xlab('') +
  ylab("Value")

p1

p2 <- dat %>%
  filter(!is.na(aor)) %>% 
  dplyr::select(fy, aor, contains('diff')) %>% 
  pivot_longer(cols=-c('fy', 'aor')) %>% 
  ggplot(aes(x = as.factor(fy), y=value, color=name, group=name)) +
  geom_line() +
  scale_x_discrete(breaks=seq(2013,2024,4)) +
  labs(title = "Difference between ICE enforcement events per FY") +
  facet_wrap(~aor) +
  xlab('') +
  ylab("Value")

p2

```

# Basic mapping by ICE AOR

ICE ERO divides the country into 24 Areas of Responsibility (AORs) and Field Offices, mapped below. Most AORs correspond to one or more U.S. states and territories; the states of CA, NY, and TX are divided between two or more AORs. (An additional "HQ" AOR does not have an associated territorial jurisdiction; some ICE datasets also refer to an "HAL" AOR for the south Texas region centering on Harlingen, TX.)

```{r maps_setup, echo=FALSE, message=FALSE, include=FALSE}
  
states <- unique(county_aor$geoid_state)

all_counties <- counties(state=states) %>%
  shift_geometry()

# We can easily combine county-level geometries into an AOR shape!

aor_geom <- left_join(all_counties, county_aor, by=c('GEOID' = "geoid")) %>%
  group_by(aor) %>%
  summarize(geometry = sf::st_union(geometry))

aor_field_office <- read_delim(here('share', 'hand', 'aor_ero_field_office.csv'), delim = ',')

aor_field_office_sf <- aor_field_office %>%
  st_as_sf(coords = c("long", "lat"), crs=4326)

```

```{r map_aor, echo=FALSE, message=FALSE, include=TRUE}

p1 <- aor_geom %>%
  ggplot(aes(fill=aor)) +
  geom_sf(color='black') +
  geom_sf(data = aor_field_office_sf, aes(geometry = geometry), show.legend = FALSE) +
  ggrepel::geom_label_repel(
    data = aor_field_office_sf,
    aes(label = aor, geometry = geometry),
    stat = "sf_coordinates",
    min.segment.length = 0,
    force=2,
    show.legend = FALSE
  ) +
  theme_void() +
  labs(title = "ICE AORs and Field Office locations")

p1

```

```{r enforcement_per_capita}

dat_map <- dat %>%
  mutate(fy = as.numeric(as.character(fy))) %>%
  full_join(demog, by=c('aor' = 'aor', 'fy' = 'year')) %>%
  group_by(aor) %>%
  fill(contains('pop')) %>%
  left_join(aor_geom, by='aor')

p0 <- dat_map %>%
  filter(fy == 2022,
         aor != "HQ") %>%
  mutate(encounters_pc = n_encounters / total_pop * pc_scale) %>%
  ggplot(aes(geometry=geometry, fill=encounters_pc)) +
  geom_sf() +
  scale_fill_viridis_c() +
  theme_void() +
  labs(title = "ICE encounters per 100,000 pop., 2022")

p1 <- dat_map %>%
  filter(fy == 2022,
         aor != "HQ") %>%
  mutate(arrests_pc = n_arrests / total_pop * pc_scale) %>%
  ggplot(aes(geometry=geometry, fill=arrests_pc)) +
  geom_sf() +
  scale_fill_viridis_c() +
  theme_void() +
  labs(title = "ICE arrests per 100,000 pop., 2022")

p2 <- dat_map %>%
  filter(fy == 2022,
         aor != "HQ") %>%
  mutate(removals_pc = n_removals / total_pop * pc_scale) %>%
  ggplot(aes(geometry=geometry, fill=removals_pc)) +
  geom_sf() +
  scale_fill_viridis_c() +
  theme_void() +
  labs(title = "ICE removals per 100,000 pop., 2022")

p0
p1
p2

```
